{"ts":1373427756309,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"// TODO: language support detection by NLTK\n\n/**\n * @name CCNY Senior Project\n * @authors: Emilie Bodden, Sahat Yalkabov\n * @contributors: Emilie Chen, Hannah PyCon\n * @date May 5, 2013\n */\nvar async = require('async'),\n    AWS = require('aws-sdk'),\n    email = require('emailjs'),\n    express = require('express'),\n    filesize = require('filesize'),\n    Dropbox = require('dropbox'),\n    http = require('http'),\n    fs = require('fs'),\n    moment = require('moment'),\n    mongoose = require('mongoose'),\n    MongoStore = require('connect-mongo')(express),\n    path = require('path'),\n    passport = require('passport'),\n    GoogleStrategy = require('passport-google-oauth').OAuth2Strategy,\n    request = require('request'),\n    _ = require('underscore');\n\n\nvar config = require('./config'),\n    User = require('./schema').User,\n    FileSchema = require('./schema').File;\n\n\nvar app = express();\n\n\n// Connect to MongoDB\n// TODO: MONGOLAB IS NOW USING GOOGL E CLOUD PLATFORM as host name is cloudbucket\nmongoose.connect(config.MONGOLAB);\n\nvar File = mongoose.model('File', FileSchema);\n\n// Load Amazon AWS credentials\nAWS.config.loadFromPath('./aws.json');\n\n/**\n * In this example, only the Google ID is serialized to the session,\n * keeping the amount of data stored within the session small.\n * When subsequent requests are received, this ID is used to find the user,\n * which will be restored to req.user.\n */\npassport.serializeUser(function(user, done) {\n  done(null, user.googleId);\n});\n\npassport.deserializeUser(function(googleId, done) {\n  User.findOne({ 'googleId': googleId }, function(err, user) {\n    done(err, user);\n  });\n});\n\n\n/**\n * Use the GoogleStrategy within Passport.\n * Strategies in Passport require a `verification` function, which accept\n * credentials (in this case, an accessToken, refreshToken, and Google\n * profile), and invoke a callback 'done' with a user object.\n */\npassport.use(new GoogleStrategy({\n    clientID: config.GOOGLE_CLIENT_ID,\n    clientSecret: config.GOOGLE_CLIENT_SECRET,\n    callbackURL: \"http://localhost:3000/auth/google/callback\"\n    //callbackURL: \"http://semanticweb.aws.af.cm/auth/google/callback\"\n  },\n  function(accessToken, refreshToken, profile, done) {\n    process.nextTick(function () {\n      User.findOne({ 'googleId': profile.id }, function(err, existingUser) {\n        if(existingUser) {\n          console.log('User: ' + existingUser.displayName + ' found and logged in!');\n          done(null, existingUser);\n        } else {\n          var newUser = new User({\n            googleId: profile.id,\n            accessToken: accessToken,\n            displayName: profile.displayName,\n            link: profile._json.link,\n            picture: profile._json.picture,\n            gender: profile._json.gender,\n            email: profile._json.email,\n            locale: profile._json.locale,\n            verified: profile._json.verified_email\n          });\n          newUser.save(function(err) {\n            if(err) return err;\n            console.log('New user: ' + newUser.displayName + ' created and logged in!');\n            done(null, newUser);\n          });\n        }\n      });\n    });\n  }\n));\n\n\n// Express Configuration\napp.set('port', process.env.PORT || 3000);\napp.set('views', __dirname + '/views');\napp.set('view engine', 'jade');\napp.use(express.favicon());\napp.use(express.logger('dev'));\napp.use(express.bodyParser({\n  uploadDir: __dirname,\n  keepExtensions: true\n}));\napp.use(express.cookieParser());\napp.use(express.session({\n  secret: 'LOLCATS',\n  store: new MongoStore({ url: config.MONGOLAB })\n}));\napp.use(passport.initialize());\napp.use(passport.session());\napp.use(express.methodOverride());\napp.use(app.router);\napp.use(express.static(path.join(__dirname, 'public'), { maxAge: 99999 }));\napp.enable('jsonp callback');\napp.use(function (req, res, next) {\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');\n  res.setHeader('Access-Control-Allow-Headers', 'X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept');\n  next();\n});\n\n\n// Express development configuration\nif ('development' === app.get('env')) {\n  app.use(express.errorHandler());\n}\n\n\n/**\n * Simple route middleware to ensure user is authenticated.\n * Use this route middleware on any resource that needs to be protected.  If\n * the request is authenticated (typically via a persistent login session),\n * the request will proceed.  Otherwise, the user will be redirected to the\n * login page.\n */\nfunction ensureAuthenticated(req, res, next) {\n  if (req.isAuthenticated()) { return next(); }\n  res.redirect('/login');\n}\n\n\n/**\n * @route GET /index\n */\napp.get('/', function(req, res) {\n  if (req.user) {\n    // Documents returned from queries with the lean option enabled are plain javascript objects, not MongooseDocuments.\n    // They have no save method, getters/setters or other Mongoose magic applied.\n    // And most importantly they are mutable, which allows us to apply formatting.\n    File.find({ user: req.user.googleId }).lean().exec(function(err, files) {\n\n      // Prettify file sizes\n      _.each(files, function(file) {\n        file.size = filesize(file.size);\n        file.lastModified = moment(file.lastModified).fromNow();\n      });\n      console.log(files);\n      res.render('index', {\n        user: req.user,\n        files: files\n      });\n    });\n  } else {\n    res.render('index', { user: req.user });\n  }\n});\n\n\n/**\n * @route GET /account\n */\napp.get('/account', ensureAuthenticated, function(req, res){\n  res.render('settings', { user: req.user, active: 'active' });\n});\n\n\n/**\n * @route GET /login\n */\napp.get('/login', function(req, res){\n  res.render('/', { user: req.user });\n});\n\n\n/**\n * @route GET /logout\n */\napp.get('/logout', function(req, res){\n  req.logout();\n  res.redirect('/');\n});\n\n/**\n * @route GET /auth/google\n * Use passport.authenticate() as route middleware to authenticate the\n * request.  The first step in Google authentication will involve\n * redirecting the user to google.com.  After authorization, Google\n * will redirect the user back to this application at /auth/google/callback\n */\napp.get('/auth/google', passport.authenticate('google', {\n  scope: [\n    'https://www.googleapis.com/auth/userinfo.profile',\n    'https://www.googleapis.com/auth/userinfo.email'\n  ]\n}), function (req, res) {\n  // The request will be redirected to Google for authentication, so this\n  // function will not be called.\n});\n\n/**\n * GET /auth/google/callback\n * Use passport.authenticate() as route middleware to authenticate the\n * request.  If authentication fails, the user will be redirected back to the\n * login page.  Otherwise, the primary route function function will be called,\n * which, in this example, will redirect the user to the home page.\n */\napp.get('/auth/google/callback',\n  passport.authenticate('google', { failureRedirect: '/login'}), function (req, res) {\n  res.redirect('/');\n});\n\napp.get('/search', function(req, res) {\n  res.render('search');\n});\n\n\napp.post('/search', function(req, res) {\n  User.search({ query: 'sahat' }, function(err, results) {\n\n  });\n\n  request.get('http://elastic-sahat.rhcloud.com', function(error, response, body) {\n    res.send(body);\n  });\n});\n\n\n/**\n * Creates a new user account\n * @param Full Name, Username, Email, Password\n * @return 200 OK\n */\napp.post('/signup', function(req, res) {\n  var user = new User({\n    fullName: req.body.name,\n    email: req.body.email,\n    password: req.body.password\n  });\n\n  user.save(function (err) {\n    if (err) {\n      console.log(err);\n    } else {\n      console.log('User has been successfully created');\n    }\n  });\n\n  res.end();\n});\n\n/**\n * Creates a new file object for a given user\n * @param Username\n * @return 200 OK\n */\napp.post('/files', function(req, res) {\n  var path = '';\n\n  // Windows uses backslash for file path, Linux uses forward slashuuuuuuiuhiu\n  if (process.platform.match(/^win/)) {\n     path = req.files.myFile.path.split(\"\\\\\").slice(-1).join(\"\\\\\");\n  } else {\n     path = req.files.myFile.path.split(\"/\").slice(-1).join(\"/\");\n  }\n\n  var file = {\n    name: req.files.myFile.name,\n    extension: path.split('.')[1].toLowerCase(),\n    type: req.files.myFile.type,\n    size: req.files.myFile.size,\n    path: path,\n    lastModified: req.files.myFile.lastModifiedDate,\n    user: req.user.googleId\n  };\n\n  fs.readFile(path, function (err, data) {\n    if (err) return res.send(500, err);\n\n    var s3 = new AWS.S3({ params: { Bucket: 'semanticweb' } });\n\n    s3.createBucket(function() {\n      s3.putObject({ Key: path, Body: data }, function(err, data) {\n        if (err) {\n          console.log(\"Error uploading data: \", err);\n        } else {\n          console.log(\"Successfully uploaded data to semanticweb\");\n\n          // send a request to python cluster\n          request.post({ url: 'http://127.0.0.1:5000', \n            form: { path:path, extension:path.split('.')[1].toLowerCase() } }, function(e, r, body) {\n            \n\n\n            console.log(body);\n            // Save to MongoDB (OK to be asynchronous)\n            var mongoFile = new File(file);\n\n            // NLP analysis on file to generate keywords\n            var tags = JSON.parse(body).tags\n            console.log(tags);\n            var myArr = tags;\n            mongoFile.keywords = tags;\n\n            // nltk analysis to generate summary\n            mongoFile.summary = 'Quick document summary goes here';\n\n            mongoFile.save(function(err) {\n              if (err) return res.send(500, err);\n              console.log('Saved file metadata to MongoDB successfully')\n            });\n\n            res.redirect('/');\n\n\n          });\n          console.log('Sent a POST request to Python');\n\n          // delete temp file on disk, now that it is on S3\n          fs.unlink(path, function (err) {\n            if (err) return res.send(500, err);\n            console.log('successfully deleted temp file');\n          });\n\n        }\n      });\n    });\n  });\n\n  \n});\n\n// Update all files for a specified user\napp.put('/files', function(req, res) {\n  var user = req.params.user;\n\n});\n\n// Retrieve detailed info about a file\napp.get('/files/:id', function(req, res) {\n  File.findOne({ '_id': req.params.id }, function(err, file) {\n    if (file) {\n      res.render('detail', {\n        user: req.user,\n        file: file\n      });\n    } else {\n      res.redirect('/');\n    }\n  });\n});\n\n// Update a given file for specified user\napp.put('/files/:id', function(req, res) {\n  var user = req.params.user;\n  var fileId = req.params.id;\n});\n\n/**\n * Deletes a file object for a given user\n * @param Username\n * @param File ID\n * @return 200 OK\n */\napp.del('/files/:id', function(req, res) {\n  var user = req.params.user;\n  var fileId = req.params.id;\n});\n\n\n\nhttp.createServer(app).listen(app.get('port'), function(){\n  console.log('Express server listening on port ' + app.get('port'));\n});\n"]],"start1":0,"start2":0,"length1":0,"length2":10910}]],"length":10910}
{"contributors":[],"silentsave":true,"ts":1373428370965,"patch":[[{"diffs":[[0,"web."],[-1,"aws.af.cm"],[1,"sahat.c9.io"],[0,"/aut"]],"start1":2115,"start2":2115,"length1":17,"length2":19},{"diffs":[[0,"rr, data) {\n"],[-1,"    "],[0,"if (err) ret"]],"start1":8396,"start2":8396,"length1":28,"length2":24}]],"length":10908,"saved":false}
{"ts":1373428373308,"patch":[[{"diffs":[[0,"ck\"\n    "],[-1,"//"],[0,"callback"]],"start1":2076,"start2":2076,"length1":18,"length2":16}]],"length":10906,"saved":false}
{"ts":1373428374664,"patch":[[{"diffs":[[0,"SECRET,\n    "],[1,"//"],[0,"callbackURL:"]],"start1":2010,"start2":2010,"length1":24,"length2":26}]],"length":10908,"saved":false}
{"ts":1373558831647,"patch":[[{"diffs":[[0,"p.get('/"],[1,"fil"],[0,"', funct"]],"start1":4674,"start2":4674,"length1":16,"length2":19}]],"length":10911,"saved":false}
{"ts":1373558832875,"patch":[[{"diffs":[[0,"p.get('/"],[-1,"fil"],[0,"', funct"]],"start1":4674,"start2":4674,"length1":19,"length2":16}]],"length":10908,"saved":false}
{"ts":1373558837867,"patch":[[{"diffs":[[0,"p.get('/"],[1,"fff"],[0,"', funct"]],"start1":4674,"start2":4674,"length1":16,"length2":19}]],"length":10911,"saved":false}
