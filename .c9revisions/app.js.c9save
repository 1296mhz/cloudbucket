{"ts":1374116152795,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"/**\n * @name CCNY Senior Project\n * @authors: Emilie Bodden, Sahat Yalkabov\n * @contributors: Emilie Chen, Hannah PyCon\n * @date May 5, 2013\n */\nvar async = require('async'),\n    AWS = require('aws-sdk'),\n    AlchemyAPI = require('alchemy-api'),\n    email = require('emailjs'),\n    express = require('express'),\n    filesize = require('filesize'),\n    Dropbox = require('dropbox'),\n    http = require('http'),\n    fs = require('fs'),\n    moment = require('moment'),\n    mongoose = require('mongoose'),\n    MongoStore = require('connect-mongo')(express),\n    path = require('path'),\n    passport = require('passport'),\n    GoogleStrategy = require('passport-google-oauth').OAuth2Strategy,\n    request = require('request'),\n    _ = require('underscore');\n\n// Integrates underscore.string with underscore library\n_.str = require('underscore.string');\n_.mixin(_.str.exports());\n\n\n\n// Case = require('case');\n\n// TODO: Reserved for later\n// Case.upper('foo_bar')                       -> 'FOO BAR'\n// Case.lower('fooBar')                        -> 'foo bar'\n// Case.snake('Foo bar!')                      -> 'foo_bar'\n// Case.squish('foo.bar')                      -> 'FooBar'\n// Case.camel('foo, bar')                      -> 'fooBar'\n// Case.constant('Foo-Bar')                    -> 'FOO_BAR'\n// Case.title('foo v. bar')                    -> 'Foo v. Bar'\n// Case.capital('foo_v_bar')                   -> 'Foo V Bar'\n// Case.sentence('\"foo!\" said bar', ['Bar'])   -> '\"Foo!\" said Bar'\n\n// Case.of('foo')          -> 'lower'\n// Case.of('foo_bar')      -> 'snake'\n// Case.of('Foo v Bar')    -> 'title'\n// Case.of('foo_ Bar')     -> undefined\n\n// Case.flip('FlipMe')     -> 'fLIPmE'\n// Case.flip('TEST THIS!') -> 'test this!'\n\n// Case.type('bang', function(s) {\n//     return Case.upper(s, '!')+'!';\n// });\n// Case.bang('bang')       -> 'BANG!'\n// Case.of('TEST!THIS!')   -> 'bang'\n\n\nvar config = require('./config'),\n    User = require('./schema').User,\n    FileSchema = require('./schema').File;\n\n\nvar app = express();\n\n\n// Connect to MongoDB\nmongoose.connect(config.MONGOLAB, function(err) {\n  if (err) {\n    console.error('Database connection error');\n    return res.send(500, 'Database connection error');\n  }\n});\nvar alchemy = new AlchemyAPI('15d085702f92ef2b5c85bb7f802da39d19c0fd59');\n\nvar File = mongoose.model('File', FileSchema);\n\n// Load Amazon AWS credentials\nAWS.config.loadFromPath('./aws.json');\n\n/**\n * In this example, only the Google ID is serialized to the session,\n * keeping the amount of data stored within the session small.\n * When subsequent requests are received, this ID is used to find the user,\n * which will be restored to req.user.\n */\npassport.serializeUser(function(user, done) {\n  done(null, user.googleId);\n});\n\npassport.deserializeUser(function(googleId, done) {\n  User.findOne({ 'googleId': googleId }, function(err, user) {\n    done(err, user);\n  });\n});\n\n\n/**\n * Use the GoogleStrategy within Passport.\n * Strategies in Passport require a `verification` function, which accept\n * credentials (in this case, an accessToken, refreshToken, and Google\n * profile), and invoke a callback 'done' with a user object.\n */\npassport.use(new GoogleStrategy({\n    clientID: config.GOOGLE_CLIENT_ID,\n    clientSecret: config.GOOGLE_CLIENT_SECRET,\n    callbackURL: \"http://localhost:3000/auth/google/callback\"\n    //callbackURL: \"http://semanticweb.sahat.c9.io/auth/google/callback\"\n  },\n  function(accessToken, refreshToken, profile, done) {\n    process.nextTick(function () {\n      User.findOne({ 'googleId': profile.id }, function(err, existingUser) {\n        if(existingUser) {\n          console.log('User: ' + existingUser.displayName + ' found and logged in!');\n          done(null, existingUser);\n        } else {\n          var newUser = new User({\n            googleId: profile.id,\n            accessToken: accessToken,\n            displayName: profile.displayName,\n            link: profile._json.link,\n            picture: profile._json.picture,\n            gender: profile._json.gender,\n            email: profile._json.email,\n            locale: profile._json.locale,\n            verified: profile._json.verified_email\n          });\n          newUser.save(function(err) {\n            if(err) return err;\n            console.log('New user: ' + newUser.displayName + ' created and logged in!');\n            done(null, newUser);\n          });\n        }\n      });\n    });\n  }\n));\n\n\n// Express Configuration\napp.set('port', process.env.PORT || 3000);\napp.set('views', __dirname + '/views');\napp.set('view engine', 'jade');\napp.use(express.favicon());\napp.use(express.logger('dev'));\napp.use(express.bodyParser({\n  uploadDir: __dirname,\n  keepExtensions: true\n}));\napp.use(express.cookieParser());\napp.use(express.session({\n  secret: 'LOLCATS',\n  store: new MongoStore({ url: config.MONGOLAB })\n}));\napp.use(passport.initialize());\napp.use(passport.session());\napp.use(express.methodOverride());\napp.use(app.router);\napp.use(express.static(path.join(__dirname, 'public'), { maxAge: 99999 }));\napp.enable('jsonp callback');\napp.use(function (req, res, next) {\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');\n  res.setHeader('Access-Control-Allow-Headers', 'X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept');\n  next();\n});\n\n\n// Express development configuration\nif ('development' === app.get('env')) {\n  app.use(express.errorHandler());\n}\n\n\n/**\n * Simple route middleware to ensure user is authenticated.\n * Use this route middleware on any resource that needs to be protected.  If\n * the request is authenticated (typically via a persistent login session),\n * the request will proceed.  Otherwise, the user will be redirected to the\n * login page.\n */\nfunction ensureAuthenticated(req, res, next) {\n  if (req.isAuthenticated()) { return next(); }\n  res.redirect('/login');\n}\n\n\n/**\n * @route GET /index\n */\napp.get('/', function(req, res) {\n  if (req.user) {\n    // Documents returned from queries with the lean option enabled are plain javascript objects, not MongooseDocuments.\n    // They have no save method, getters/setters or other Mongoose magic applied.\n    // And most importantly they are mutable, which allows us to apply formatting.\n    File\n    .find({ user: req.user.googleId })\n    .sort('name')\n    .lean()\n    .exec(function(err, files) {\n      // Format \"filesize\" and \"last modified date\" to be human readable\n      _.each(files, function(file) {\n        file.size = filesize(file.size);\n        file.lastModified = moment(file.lastModified).fromNow();\n      });\n\n      res.render('index', {\n        user: req.user,\n        files: files\n      });\n    });\n  } else {\n    res.render('index', { user: req.user });\n  }\n});\n\n\n/**\n * @route GET /account\n */\napp.get('/account', ensureAuthenticated, function(req, res){\n  res.render('settings', { user: req.user, active: 'active' });\n});\n\n\n/**\n * @route GET /login\n */\napp.get('/login', function(req, res) {\n  res.render('/', { user: req.user });\n});\n\n\n/**\n * @route GET /logout\n */\napp.get('/logout', function(req, res){\n  req.logout();\n  res.redirect('/');\n});\n\n/**\n * @route GET /auth/google\n * Use passport.authenticate() as route middleware to authenticate the\n * request.  The first step in Google authentication will involve\n * redirecting the user to google.com.  After authorization, Google\n * will redirect the user back to this application at /auth/google/callback\n */\napp.get('/auth/google', passport.authenticate('google', {\n  scope: [\n    'https://www.googleapis.com/auth/userinfo.profile',\n    'https://www.googleapis.com/auth/userinfo.email'\n  ]\n}), function (req, res) {\n  // The request will be redirected to Google for authentication, so this\n  // function will not be called.\n});\n\n/**\n * GET /auth/google/callback\n * Use passport.authenticate() as route middleware to authenticate the\n * request.  If authentication fails, the user will be redirected back to the\n * login page.  Otherwise, the primary route function function will be called,\n * which, in this example, will redirect the user to the home page.\n */\napp.get('/auth/google/callback',\n  passport.authenticate('google', { failureRedirect: '/login'}), function (req, res) {\n  res.redirect('/');\n});\n\napp.get('/search', function(req, res) {\n  res.render('search');\n});\n\n\napp.post('/search', function(req, res) {\n  User.search({ query: 'sahat' }, function(err, results) {\n\n  });\n\n  request.get('http://elastic-sahat.rhcloud.com', function(error, response, body) {\n    res.send(body);\n  });\n});\n\n\n/**\n * Creates a new user account\n * @param Full Name, Username, Email, Password\n * @return 200 OK\n */\napp.post('/signup', function(req, res) {\n  var user = new User({\n    fullName: req.body.name,\n    email: req.body.email,\n    password: req.body.password\n  });\n\n  user.save(function (err) {\n    if (err) {\n      console.log(err);\n    } else {\n      console.log('User has been successfully created');\n    }\n  });\n\n  res.end();\n});\n\n\napp.get('/extract', function(req, res) {\n  var AlchemyAPI = require('alchemy-api');\n  var alchemy = new AlchemyAPI('15d085702f92ef2b5c85bb7f802da39d19c0fd59');\n\n\n  async.parallel({\n    entities: function(callback){\n      alchemy.entities('http://www.cnn.com/2013/07/12/us/snowden-getaway-options/index.html', {}, function(err, response) {\n        if (err) res.send(500, err);\n        var entities = response.entities;\n        callback(null, entities);\n      });\n    },\n    concepts: function(callback) {\n      alchemy.concepts('http://www.cnn.com/2013/07/12/us/snowden-getaway-options/index.html', {}, function(err, response) {\n        if (err) res.send(500, err);\n        var concepts = response.concepts;\n        callback(null, concepts);\n      });\n    },\n    keywords: function(callback) {\n      alchemy.keywords('http://www.cnn.com/2013/07/12/us/snowden-getaway-options/index.html', {}, function(err, response) {\n        if (err) res.send(500, err);\n        var keywords = response.keywords;\n        callback(null, keywords);\n      });\n    }\n  },\n  function(err, results) {\n    if (err) return res.send(500, err);\n    res.send(results);\n  });\n});\n\n/**\n * Creates a new file object for a given user\n * @state Signed in\n * @return Redirect to home page\n */\napp.post('/files', function(req, res) {\n  var\n    filePath = getPath(req.files.userFile.path),\n    fileName = req.files.userFile.name,\n    fileExtension = filePath.split('.').pop().toLowerCase(),\n    fileType = req.files.userFile.type,\n    fileSize = req.files.userFile.size,\n    fileLastModified = req.files.userFile.lastModifiedDate;\n\n  fs.readFile(filePath, function(err, fileData) {\n    if (err) return res.send(500, err);\n    var s3 = new AWS.S3({ params: { Bucket: 'semanticweb' } });\n    s3.createBucket(function() {\n      s3.putObject({ Key: filePath, Body: fileData }, function(err, data) {\n        if (err) return res.send(500, err);\n\n        // Extract Plain Text File\n        if (fileExtension === 'txt') {\n          var textBody = fileData.toString();\n        } else {\n          return res.send('Format not supported');\n        }\n\n        async.parallel({\n          entities: function(callback){\n            alchemy.entities(textBody, {}, function(err, response) {\n              if (err) res.send(500, err);\n              var entities = response.entities;\n              callback(null, entities);\n            });\n          },\n          category: function(callback) {\n            alchemy.category(textBody, {}, function(err, response) {\n              if (err) res.send(500, err);\n              var category = response.category;\n              callback(null, category);\n            });\n          },\n          concepts: function(callback) {\n            alchemy.concepts(textBody, {}, function(err, response) {\n              if (err) res.send(500, err);\n              var concepts = response.concepts;\n              callback(null, concepts);\n            });\n          },\n          keywords: function(callback) {\n            alchemy.keywords(textBody, {}, function(err, response) {\n              if (err) res.send(500, err);\n              var keywords = response.keywords;\n              callback(null, keywords);\n            });\n          }\n        },\n        function(err, results) {\n          if (err) return res.send(500, err);\n          var file = new File({\n            name: fileName,\n            extension: fileExtension,\n            type: fileType,\n            size: fileSize,\n            lastModified: fileLastModified,\n            keywords: results.keywords,\n            category: results.category,\n            concepts: results.concepts,\n            entities: results.entities,\n            summary: _(textBody).truncate(500),\n            path: 'https://s3.amazonaws.com/semanticweb/' + filePath,\n            user: req.user.googleId\n          });\n          file.save(function(err) {\n              if (err) return res.send(500, err);\n              console.log('Saved file metadata to MongoDB successfully');\n            });\n\n          res.redirect('/');\n          console.log(results);\n        });\n\n        fs.unlink(filePath, function (err) {\n          if (err) return res.send(500, err);\n          console.log('successfully deleted temp file');\n        });\n      });\n    });\n  });\n});\n\n// Update all files for a specified user\napp.put('/files', function(req, res) {\n  var user = req.params.user;\n\n});\n\n// Retrieve detailed info about a file\napp.get('/files/:id', function(req, res) {\n  File.findOne({ '_id': req.params.id }, function(err, file) {\n    if (file) {\n      res.render('detail', {\n        user: req.user,\n        file: file\n      });\n    } else {\n      res.redirect('/');\n    }\n  });\n});\n\n// Update a given file for specified user\napp.put('/files/:id', function(req, res) {\n  var user = req.params.user;\n  var fileId = req.params.id;\n});\n\n/**\n * Deletes a file object for a given user\n * @param Username\n * @param File ID\n * @return 200 OK\n */\napp.del('/files/:id', function(req, res) {\n  var user = req.params.user;\n  var fileId = req.params.id;\n});\n\n\n\nhttp.createServer(app).listen(app.get('port'), function(){\n  console.log('Express server listening on port ' + app.get('port'));\n});\n\n/**\n * JavaScript Utilities\n*/\n\nfunction getPath(fullPath) {\n   if (process.platform.match(/^win/)) {\n     return fullPath.split(\"\\\\\").slice(-1).join(\"\\\\\");\n  } else {\n     return fullPath.split(\"/\").slice(-1).join(\"/\");\n  }\n}"]],"start1":0,"start2":0,"length1":0,"length2":14387}]],"length":14387}
{"contributors":[],"silentsave":true,"ts":1374116254036,"patch":[[{"diffs":[[0,"SECRET,\n    "],[1,"/"],[0,"callbackURL:"]],"start1":3262,"start2":3262,"length1":24,"length2":25},{"diffs":[[0,"ck\"\n    "],[-1,"//"],[0,"callback"]],"start1":3329,"start2":3329,"length1":18,"length2":16}]],"length":14386,"saved":false}
{"ts":1374116254853,"patch":[[{"diffs":[[0,"ET,\n    "],[1,"/"],[0,"/callbac"]],"start1":3266,"start2":3266,"length1":16,"length2":17}]],"length":14387,"saved":false}
